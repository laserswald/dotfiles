#!/usr/bin/env chibi-scheme
;;;; vim:ft=scheme

(import (scheme base)
        (chibi filesystem)
	    (chibi process)
	    (lazr battery)
	    (scheme list)
        (chibi process)
        (lazr notify))

(define (approximate-percentage batteries)
  (/ (apply + (map read-capacity batteries))
     (length batteries)))

(define (system-has-low-charge? batteries)
  (< (approximate-percentage batteries) 15))

(define (sleep n)
  (system "sleep" n))

(define (check-batteries)
  (let ((batteries (get-batteries)))
	(and (system-has-low-charge? batteries)
	     (not (any is-charging? batteries)))))

(define (main)
  (if (check-batteries)
    (send-notification 
      "Battery"
      (string-append "Battery levels at approximately "
                     (number->string (approximate-percentage (get-batteries)))
                     "%")
      "critical"))
  (sleep "5")
  (main))

(main)
