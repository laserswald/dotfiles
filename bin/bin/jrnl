#!/bin/sh
# jrnl: a bullet journal designed using the Unix philosophy

JRNLFILE=${JRNLFILE:-${HOME}/org/jrnl.txt}

add_entry () {
    sign=$1
    shift
    text="$@"

    printf "%s $text\n" $sign >> $JRNLFILE
}

change_entry_type () {
    line=$1
    sign=$2

    if [ -z "$line" ]; then
        echo "jrnl: cannot change entry: no entry specified" >&2
    fi

    sed -i "$line,$line s/^./$sign/" $JRNLFILE
}

ensure_date_entry () {    
    datestr="# $(date +%F)" 
    if ! grep -q "$datestr" $JRNLFILE; then
	echo "" >> $JRNLFILE
        add_entry "#" `date +%F`
    fi
}

filter_by_type () {
    type=$1

    nl -ba | grep "^\s\+[[:digit:]]\+\s\+$1"
}

display_day () {
    ensure_date_entry
    datestr="# $(date +%F)" 
    dateline=$(grep "$datestr" $JRNLFILE | cut -d: -f1)
    sed "$dateline,/^#/p" $JRNLFILE
}

while getopts ':f:' flag; do
    case $flag in 
        f) 
            JRNLFILE=$OPTARG
        ;;  
        \?)
            echo "Unknown option. Valid options: -f"
            exit 1
        ;;
    esac
done
shift $((OPTIND - 1))

if [ $# -lt 1 ]; then
	echo "needs command"
	exit 1
fi

cmd=$1
shift

case $cmd in  
    ed|edit)
        $EDITOR $JRNLFILE
		exit 0
    ;;
    ev|event) 
		ensure_date_entry
        SIGN='o'
        add_entry $SIGN "$@"
		exit 0
    ;;
    t|task) 	
		ensure_date_entry
        SIGN='.'
        add_entry $SIGN "$@"
		exit 0
    ;;
    d|'do')
        change_entry_type $1 'x'
		exit 0
    ;;
    n|note) 
		ensure_date_entry
        SIGN='-'
        add_entry $SIGN "$@"
		exit 0
    ;; 
    ls|list-tasks) 
        filter_by_type "\\." < $JRNLFILE
		exit 0
    ;; 
    today)
		display_day
		exit 0
    ;;
    *)
        echo "Unknown command."
        exit 1
    ;;
esac

